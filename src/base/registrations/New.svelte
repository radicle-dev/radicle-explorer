<script lang="ts">
  import { onMount } from 'svelte';
  import { navigate } from 'svelte-routing';
  import { formatAddress, formatBalance } from '@app/utils';
  import { session } from '@app/session';
  import type { Config } from '@app/config';

  import Connect from '@app/Connect.svelte';
  import Modal from '@app/Modal.svelte';
  import Loading from '@app/Loading.svelte';

  import { registrar, registrationFee } from './registrar';

  enum State {
    CheckingAvailability,
    NameAvailable,
    NameUnavailable,
  }

  export let config: Config;
  export let subdomain: string;
  export let owner: string | null;

  let fee: string;
  let state = State.CheckingAvailability;
  $: registrationOwner = owner || ($session && $session.address);

  function begin() {
    navigate(`/registrations/${subdomain}/submit?${
      registrationOwner ? new URLSearchParams({ owner: registrationOwner }) : ''
    }`);
  }

  onMount(async () => {
    const [_fee, isAvailable] = await Promise.all([
      registrationFee(config),
      registrar(config).available(subdomain),
    ]);

    fee = formatBalance(_fee);

    if (isAvailable) {
      state = State.NameAvailable;
    } else {
      state = State.NameUnavailable;
    }
  });
</script>

<Modal narrow>
  <span slot="title">
    <div>üåê</div>
    <span>Register a name</span>
  </span>

  <span slot="subtitle">
    {subdomain}.{config.registrar.domain}
  </span>

  <span slot="body">
    {#if state === State.NameAvailable}
      {#if registrationOwner}
        The name <strong>{subdomain}</strong> is available for registration
        under account <strong>{formatAddress(registrationOwner)}</strong>
        for <strong>{fee} RAD</strong>.
      {:else}
        The name <strong>{subdomain}</strong> is available
        for <strong>{fee} RAD</strong>.
      {/if}
    {:else if state === State.NameUnavailable}
      The name <span class="highlight">{subdomain}</span> is not available for registration.
    {:else if state === State.CheckingAvailability}
      <Loading small center />
    {/if}
  </span>

  <span slot="actions">
    {#if state === State.NameAvailable}
      {#if $session}
        <button on:click={begin} class="primary register">
          Begin registration &rarr;
        </button>
      {:else}
        <Connect caption="Connect to register" className="primary" {config} />
      {/if}

      <button on:click={() => navigate("/registrations")} class="text">
        Cancel
      </button>
    {:else if state === State.NameUnavailable}
      <button on:click={() => navigate("/registrations")} class="">
        Back
      </button>
    {/if}
  </span>
</Modal>
